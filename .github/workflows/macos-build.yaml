name: macOS Build with Artifacts
on:
  push:
    branches:
      - master
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: false
        default: 'release'
        type: choice
        options:
          - release
          - debug

jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: Git Checkout
        uses: actions/checkout@v4
      
      - name: Install Dependencies
        run: |
          # Xcode command line tools should be preinstalled
          # Verify required tools
          which clang make perl python3 git
          
      - name: Generate Sources
        run: |
          make -C auto
          
      - name: Build Libraries and Utilities
        run: |
          make -j$(sysctl -n hw.ncpu)
          
      - name: Fix Library Paths for Utilities
        run: |
          # Rewrite dylib install_name and utility references for portable artifacts
          install_name_tool -id @rpath/libGLEW.2.2.0.dylib lib/libGLEW.2.2.0.dylib
          install_name_tool -change /usr/local/lib/libGLEW.2.2.0.dylib @loader_path/../lib/libGLEW.2.2.0.dylib bin/glewinfo || \
            install_name_tool -change @rpath/libGLEW.2.2.0.dylib @loader_path/../lib/libGLEW.2.2.0.dylib bin/glewinfo
          install_name_tool -change /usr/local/lib/libGLEW.2.2.0.dylib @loader_path/../lib/libGLEW.2.2.0.dylib bin/visualinfo || \
            install_name_tool -change @rpath/libGLEW.2.2.0.dylib @loader_path/../lib/libGLEW.2.2.0.dylib bin/visualinfo
          # Verify the changes
          otool -L bin/glewinfo
          otool -L bin/visualinfo
          
      - name: Test Utilities
        run: |
          # Quick smoke test
          echo "Testing glewinfo with core profile:"
          ./bin/glewinfo -version 3.2 -profile core 2>&1 | head -10 || true
          echo ""
          echo "Testing visualinfo (uses core profile by default):"
          ./bin/visualinfo 2>&1 | head -20 || true
          
      - name: Package Artifacts
        run: |
          mkdir -p artifacts/lib artifacts/bin artifacts/include
          cp -r lib/*.dylib lib/*.a artifacts/lib/
          cp bin/glewinfo bin/visualinfo artifacts/bin/
          cp -r include/GL artifacts/include/
          tar -czf glew-macos-artifacts.tar.gz -C artifacts .
          
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: glew-macos-${{ github.sha }}
          path: glew-macos-artifacts.tar.gz
          retention-days: 30
